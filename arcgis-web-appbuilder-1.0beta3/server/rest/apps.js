function insertAndCopyApp(e,i,t){insertToDB(e,function(e,n){return e?void t(e):void copyAppFiles(i,n[0].id,function(e){e?(logger.error("Copy app error.","fromId:",i,"toId:",n[0].id,e),deleteFromDB(n[0].id,function(){}),t(e)):t(null,n)})})}function addExtraPropertyOfAppConfig(e,i,t){e.title=i.title,e.isWebTier=i.isWebTier,e.portalUrl=i.portalUrl,e.appId=i.appId,e.map.itemId=i.map.itemId,e.geometryService=i.geometryService,e.httpProxy=i.httpProxy,i.map.mapOptions.extent&&(e.map.mapOptions||(e.map.mapOptions={}),e.map.mapOptions.extent=i.map.mapOptions.extent),t(null,e)}function copyAppFiles(e,i,t){var n="./apps/"+e.toString()+"/",o="./apps/"+i.toString()+"/";fse.mkdirsSync(o),predefinedApps.indexOf(e)>-1?copyFromStemApp(e,i).then(function(){t()},function(e){t(e)}):fse.copy(n,o,function(e){t(e)})}function copyFromStemApp(e,i){var t=getAppPath(e),n=getAppPath(i),o=getAppPath("stemapp"),s=[],r=deferred();return fs.existsSync(t)?(fs.mkdirSync(n+"themes"),fs.mkdirSync(n+"widgets"),s.push(fseCopy(o+"jimu.js",n+"jimu.js")),s.push(fseCopy(o+"images",n+"images")),s.push(fseCopy(o+"libs",n+"libs")),s.push(fseCopy(o+"index.html",n+"index.html")),s.push(fseCopy(o+"env.js",n+"env.js")),s.push(fseCopy(o+"simpleLoader.js",n+"simpleLoader.js")),s.push(fseCopy(o+"init.js",n+"init.js")),s.push(fseCopy(o+"web.config",n+"web.config")),s.push(fseCopy(o+"dynamic-modules",n+"dynamic-modules")),s.push(fseCopy(o+"readme.html",n+"readme.html")),s.push(fseCopy(t+"config.json",n+"config.json")),fse.readJson(t+"config.json",function(e,t){var p;return e?(r.reject(e),r.promise):(p="themes/"+t.theme.name,s.push(fseCopy(o+p,n+p)),visitElement(t,function(e,t,n){e.widgets||!e.uri||n||s.push(copyWidgetToApp(i,getWidgetNameFromUri(e.uri)))}),t.splashPage&&s.push(copyWidgetToApp(i,getWidgetNameFromUri(t.splashPage))),t.about&&s.push(copyWidgetToApp(i,getWidgetNameFromUri(t.about))),void deferred.apply(this,s).then(function(e){var i=null;e.forEach(function(e){e&&(i=e)}),i?r.reject(i):r.resolve()}))}),r.promise):(r.reject(Error(t+" not exists.")),r.promise)}function visitElement(e,i){function t(i,t){var n,o,s;if(e[i]){if(e[i].groups)for(n=0;n<e[i].groups.length;n++)for(t(e[i].groups[n],n,!1),o=0;o<e[i].groups[n].widgets.length;o++)s=e[i].groups[n].widgets[o].uri&&e[i].groups[n].widgets[o].uri.indexOf("themes/"+e.theme.name)>-1,t(e[i].groups[n].widgets[o],o,s);if(e[i].widgets)for(n=0;n<e[i].widgets.length;n++)s=e[i].widgets[n].uri&&e[i].widgets[n].uri.indexOf("themes/"+e.theme.name)>-1,t(e[i].widgets[n],n,s)}}t("widgetOnScreen",i),t("widgetPool",i)}function deleteApp(e,i){try{fse.removeSync(getAppPath(e)),fse.removeSync(getZipFilePath(e)),i()}catch(t){i(t)}}function findApps(e,i,t){e||(e={}),t||(t=[["isTemplate","desc"],["lastUpdated","desc"]]),dbutils.find("apps",e,function(e,t){return e?void i(e,[]):void i(null,t)},{sort:t})}function insertToDB(e,i){dbutils.insert("apps",e,i)}function deleteFromDB(e,i){dbutils.remove("apps",{_id:e},i)}function getCurrentTime(){var e,i,t=new Date;return e=t.toISOString(),i=e.indexOf("T"),e=e.slice(0,i),e+" "+t.toLocaleTimeString()}function copyWidgetsInConfigToApp(e,i){var t=(getAppPath(e),deferred()),n=[];return visitElement(i,function(i,t,o){if(!i.widgets&&i.uri&&!o){var s=i.uri.split("/");s.pop();var r=s.pop();n.push(copyWidgetToApp(e,r))}}),deferred.apply(this,n).then(function(){t.resolve()},function(){t.reject()}),t.promise}function copyWidgetToApp(e,i){var t=getAppPath(e),n=deferred();return fs.existsSync(t+"widgets/"+i+"/Widget.js")?(n.resolve(),n.promise):(widgets.getWidgetByName(i,function(o,s){o||null===s?(logger.warn("copy widget error.",i,o),n.resolve()):fse.copy(s.location,t+"widgets/"+i,function(t){t?n.reject(t):(logger.info("copy widget",i,"to app",e),n.resolve())})}),n.promise)}function copyThemeToApp(e,i){var t=getAppPath(e),n=deferred();return fs.existsSync(t+"themes/"+i)?(n.resolve(),n.promise):(themes.getThemeByName(i,function(o,s){return o?(n.reject(Error("Can not find the theme")),n.promise):void fse.copy(s.location,t+"themes/"+i,function(t){return t?(n.reject(t),n.promise):(logger.info("copy theme",i,"to app",e),void n.resolve())})}),n.promise)}function removeThemes(e,i){var t=getAppPath(e),n=deferred();try{var o=fs.readdirSync(t+"themes/");o.forEach(function(n){n!==i.theme.name&&fs.existsSync(t+"themes/"+n)&&(fse.removeSync(t+"themes/"+n),logger.info("remove theme",n,"from app",e))})}catch(s){n.reject(s)}return n.resolve(),n.promise}function removeWidgets(e,i){var t=getAppPath(e),n=deferred();try{var o=fs.readdirSync(t+"widgets");o.forEach(function(n){var o=!1;visitElement(i,function(e){return!e.widgets&&e.uri&&e.uri.indexOf(n)>-1?(o=!0,!0):void 0}),o?(removeWidgetIcons(t,n,i),removeWidgetConfigs(t,n,i)):(fse.removeSync(t+"widgets/"+n),logger.info("remove widget",n,"from app",e))})}catch(s){n.reject(s)}return n.resolve(),n.promise}function removeWidgetIcons(e,i,t){fs.readdirSync(path.join(e,"widgets",i,"images")).forEach(function(n){if(n.startWith("icon_")){var o=n.substring(5,n.length-4),s=!1;visitElement(t,function(e){return!e.widgets&&e.uri&&e.label===o?(s=!0,!0):void 0}),s||(fse.removeSync(path.join(e,"widgets",i,"images",n)),logger.info("remove widget icon",n,"from app",e))}})}function removeWidgetConfigs(e,i,t){fs.readdirSync(path.join(e,"widgets",i)).forEach(function(n){if(n.startWith("config_")){var o=n.substring(7,n.length-5),s=!1;visitElement(t,function(e){return!e.widgets&&e.uri&&e.label===o?(s=!0,!0):void 0}),s||(fse.removeSync(path.join(e,"widgets",i,n)),logger.info("remove widget config",n,"from app",e))}})}function saveAppLogo(e,i){var t=getAppPath(e),n=deferred();if(i.logo&&i.logo.startWith("data:"))try{var o=utils.saveBase64ToImgSync(path.join(t,"images/logo.png"),i.logo);i.logo=o.substr(path.join(t).length),n.resolve()}catch(s){n.reject(s)}else n.resolve();return n.promise}function saveWidgetsIcon(e,i){var t=getAppPath(e),n=deferred();return visitElement(i,function(e){if(e.uri){var i=getWidgetNameFromUri(e.uri),o=null;if(e.icon&&e.icon.startWith("data:")){o=e.icon,e.icon="widgets/"+i+"/images/icon_"+e.label+".png";try{var s=utils.saveBase64ToImgSync(path.join(t,e.icon),o);e.icon=s.substr(path.join(t).length)}catch(r){n.reject(r)}}}}),n.resolve(),n.promise}function saveWidgetsConfig(e,i){var t=getAppPath(e),n=deferred(),o=[];return visitElement(i,function(e){if(e.uri){var i=getWidgetsDirFromUri(e.uri),s=null;if(e.config&&"object"==typeof e.config){s=e.config,e.config=i+"/config_"+e.label+".json";try{processWidgetConfig(path.join(t,i),s),o.push(fseWriteJson(t+e.config,s))}catch(r){n.reject(r)}}}}),0===o.length?n.resolve():deferred.apply(this,o).then(function(){n.resolve()},function(e){n.reject(e)}),n.promise}function processWidgetConfig(e,i){utils.visitObject(i,function(i,t){/^data:image\/.*;base64,/.test(i[t])&&saveImageInWidgetConfig(e,i,t)})}function saveImageInWidgetConfig(e,i,t){if(!/^data:image\/(png|jpeg|bmp|gif);base64,/.test(i[t]))throw Error("wrong image format.");var n,o=utils.findMaxFileIndexInFolder(path.join(e,"images"),t);n=-1===o?t+".png":t+"_"+(o+1)+".png";var s=utils.saveBase64ToImgSync(path.join(e,"images",n),i[t]);i[t]=s.substr(path.join(e).length+1),i[t]=i[t].replace("\\","/")}function saveAppConfig(e,i){var t=getAppPath(e);return fseWriteJson(t+"config.json",i)}function getAppPath(e){return e+="","stemapp"===e?"../client/stemapp/":predefinedApps.indexOf(e)>-1?path.join("../client/builder/predefined-apps/",e,"/"):path.join("./apps/",e,"/")}function getZipFilePath(e){return"./apps/zips/"+e+".zip"}function getAGOLZipFilePath(e){return"./apps/zips/"+e+"AGOLTemplate.zip"}function getWidgetNameFromUri(e){var i=e.split("/");return i.pop(),i.pop()}function getWidgetsDirFromUri(e){var i=e.split("/");return i.pop(),i.join("/")}function zipApp(e,i){var t=getAppPath(e);t=path.normalize(t);try{fs.existsSync("./apps/zips")||fs.mkdirSync("./apps/zips");var n=fse.readJsonSync(path.join(getAppPath(e),"config.json")),o=n.portalUrl;"/"!==o.substr(o.length-1,o.length)&&(o+="/"),getApiUrlByPortal(o,function(n){var o=new JSZip;utils.visitFolderFiles(t,function(e,i,s){var r,p=e.substr(t.length,e.length);s?o.folder(p):"env.js"===p?(r=fs.readFileSync(e,{encoding:"utf-8"}),r=r.replace("//apiUrl=[POINT_TO_ARCGIS_API_FOR_JAVASCRIPT];",'apiUrl = "'+n+'";'),o.file(p,r)):(r=fs.readFileSync(e),o.file(p,r))});var s=o.generate({type:"nodebuffer",compression:"DEFLATE"});fs.writeFileSync(getZipFilePath(e),s,"binary"),i()})}catch(s){console.log(s),i(s)}}function getApiUrlByPortal(e,i){return e.indexOf("arcgis.com")>-1?void i("//js.arcgis.com/3.11"):void request(e+"sharing/rest?f=json",function(t,n,o){if(t||200!=n.statusCode)i("//js.arcgis.com/3.11");else{var s=JSON.parse(o);i(parseFloat(s.currentVersion)>=3?e+"jsapi/jsapi/":"//js.arcgis.com/3.11")}})}function unZipApp(e){var i=getAppPath(e);i=path.normalize(i);try{utils.unZipToFolderSync(getZipFilePath(e),i)}catch(t){return console.log(t),!1}return!0}function zipAGOLApp(e,i,t){try{var n=new JSZip;fs.existsSync("./apps/zips")||fs.mkdirSync("./apps/zips"),n.file(t+".zip",fs.readFileSync(e)),n.file("AGOLTemplate.json",i);var o=n.generate({type:"nodebuffer",compression:"STORE"});fs.writeFileSync(path.normalize(getAGOLZipFilePath(t)),o,"binary")}catch(s){return console.log(s),!1}return!0}function readAppConfig(e){return fse.readJsonSync(path.join(getAppPath(e),"config.json"))}function findMaxNumFromSameNameApps(e){var i,t,n,o,s=0;for(i=0;i<e.length;i++)o=e[i].name,t=o.search(/\_copy-/)+6,n=Number(o.slice(t,o.length)),n>s&&(s=n);return s++,s}function getUniqueAppName(e,i){var t,n,o;n=e.replace(/\_copy-[0-9]+/,"");var s=new RegExp("^"+n+"(_copy-[0-9])*");findApps({name:s},function(s,r){s?(logger.error("find app failed in getUniqueAppName!"),i(s)):(0===r.length?o=e:(t=findMaxNumFromSameNameApps(r),o=n+"_copy-"+t),i(s,o))},[["name","desc"]])}var deferred=require("deferred"),fs=require("fs"),path=require("path"),themes=require("./themes"),widgets=require("./widgets"),repo=require("./repo"),fse=require("fs-extra"),utils=require("../utils"),dbutils=require("../dbutils"),JSZip=new require("jszip"),request=require("request"),fseCopy=deferred.promisify(fse.copy),fseWriteJson=deferred.promisify(fse.writeJson),log4js=require("log4js"),logger=log4js.getLogger("app"),predefinedApps=fs.readdirSync("../client/builder/predefined-apps/");exports.getAppList=function(e,i){findApps({creator:e.params.username},function(e,t){e?(logger.error("getAppList failed!"),i.send({success:!1})):i.send(t)})},exports.getApp=function(e,i){var t=e.params.appId;findApps({_id:t},function(e,t){e?(logger.error("getAppfailed!"),i.send({success:!1})):(logger.debug("getApp successfully."),i.send(t[0]))})},exports.saveAppConfig=function(e,i){var t=e.params.appId;if(!t)return void i.send({success:!1,message:"No appId"});var n=JSON.parse(e.body.appConfig),o=removeThemes(t,n),s=removeWidgets(t,n),r=copyThemeToApp(t,n.theme.name),p=copyWidgetsInConfigToApp(t,n),a=saveAppLogo(t,n),d=saveWidgetsIcon(t,n),c=saveWidgetsConfig(t,n);deferred(o,s,r,p,a,d,c).then(function(){return saveAppConfig(t,n)}).then(function(){fs.existsSync(getZipFilePath(t))&&fs.unlinkSync(getZipFilePath(t)),dbutils.update("apps",{_id:t},{$set:{lastUpdated:getCurrentTime(),modified:e.body.modified}},function(e,t){e||1!==t?(console.error("update app's lastUpdateTime error when saveAppConfig"),i.send({success:!1,message:e.message})):i.send({success:!0})})},function(e){i.send({success:!1,message:e.message})})},exports.copyWidgetToApp=function(e,i){var t=e.params.appId,n=e.body.widgetName;copyWidgetToApp(t,n).then(function(){i.send({success:!0})},function(e){i.send({success:!1,message:e})})},exports.copyThemeToApp=function(e,i){var t=e.params.appId,n=e.body.themeName,o=JSON.parse(e.body.layoutConfig),s=[];s.push(copyThemeToApp(t,n)),o.theme={name:n},visitElement(o,function(e,i,n){if(!e.widgets&&e.uri&&!n){var o=e.uri.split("/");o.pop();var r=o.pop();s.push(copyWidgetToApp(t,r))}}),deferred.apply(this,s).then(function(){i.send({success:!0})},function(e){i.send({success:!1,message:e})})},exports.download=function(e,i){var t=e.params.appId,n=getZipFilePath(t);findApps({_id:t},function(e,o){if(e)i.send({success:!1});else{var s=o[0].name;fs.existsSync(n)?i.download(n,s+".zip"):zipApp(t,function(e){e?i.send({success:!1}):i.download(n,s+".zip")})}})},exports.uploadApp=function(e,i){console.log(JSON.stringify(e.body));var t;if(!e.files.app)return void e.send(400);t=e.files.app.name.replace(/\.zip/,"");var n=e.files.app.path;return utils.checkFileExistInZip(n,"config.json")&&utils.checkFileExistInZip(n,"jimu.js/")?void getUniqueAppName(t,function(t,o){insertToDB({name:o,description:"",lastUpdated:getCurrentTime(),modified:e.body.creator,creator:e.body.creator},function(t,o){if(t)return console.log("Upload app failed when inserting an app."),void i.send({success:!1,message:t});var s=o[0].id;console.log(e.files.app.path);var r="./apps/zips/"+s+".zip";fs.existsSync("./apps/zips")||fse.mkdirsSync("./apps/zips"),fse.rename(n,r,function(e){return e?(console.log("Upload app failed when moving app file from temporary location."),void i.send({success:!1,message:e})):void(unZipApp(s)?(console.log("Upload successfully."),i.send({success:!0})):(console.log("Failed to upload app when unzipping file."),i.send({success:!1,message:"error"})))})})}):(logger.error("Invalid App."),void i.send({success:!1,message:"Invalid App."}))},exports.updateApp=function(e,i){findApps({name:e.body.name,creator:e.body.creator},function(t,n){if(t)return logger.error("Find app error when update app."),void i.send({success:!1,message:"Find app error when update app."});if(1===n.length&&n[0].id!=e.body.id)return i.send({success:!1,message:"An app '"+e.body.name+"' exists already. Please choose another name."}),void logger.error("App exists. Name: "+e.body.name);var o=getCurrentTime();dbutils.update("apps",{_id:e.body.id},{$set:{name:e.body.name,description:e.body.description,lastUpdated:o,modified:e.body.modified}},function(t,n){1!==n?(logger.error("updateApp error"),i.send({success:!1})):i.send({success:!0,lastUpdated:o,modified:e.body.modified})})})},exports.updateAgolTemplateInApp=function(e,i){dbutils.update("apps",{_id:e.body.id},{$set:{agolTemplateJson:e.body.agolTemplateJson}},function(t,n){1!==n?(logger.error("Error occurs when updating AGOL template info in App."),i.send({success:!1})):(fs.existsSync(getAGOLZipFilePath(e.body.id))&&fs.unlinkSync(getAGOLZipFilePath(e.body.id)),i.send({success:!0}))})},exports.createApp=function(e,i){var t="true"===e.body.is3D?"default3DApp":"default2DApp";findApps({name:e.body.name,creator:e.body.creator},function(n,o){return n?(logger.error("Find app error when creating app."),void i.send({success:!1,message:"Find app error when creating app."})):o.length>0?(i.send({success:!1,message:"An app '"+e.body.name+"' exists already. Please choose another name."}),void logger.error("App exists. Name: "+e.body.name)):void insertAndCopyApp({name:e.body.name,description:e.body.description,lastUpdated:getCurrentTime(),is3D:e.body.is3D,creator:e.body.creator,modified:e.body.creator},t,function(t,n){return t?(logger.error("create app failed! name:",e.body.name),void i.send({success:!1,message:"Failed to create new app."})):void addExtraPropertyOfAppConfig(readAppConfig(n[0].id),JSON.parse(e.body.extraPropertyOfAppConfig),function(e,t){return e?(logger.error("Add setting value error."),void i.send({success:!1,message:"Add setting value error."})):void saveAppConfig(n[0].id,t).then(function(){i.send({success:!0,newAppId:n[0].id,apps:{}})},function(){i.send({success:!1,message:"Failed to create new app. add setting failed."})})})})})},exports.removeApp=function(e,i){deleteFromDB(e.body.id,function(t,n){return 1!==n?(logger.warn("App removed already",e.body.id),void i.send({success:!0})):void deleteApp(e.body.id,function(t){t?(logger.error("Remove app failed, unable to remove app files. id:",e.body.id),i.send({success:!1,message:"Unknown error when delete app."})):(logger.info("App removed, id:",e.body.id),i.send({success:!0}))})})},exports.duplicateApp=function(e,i){getUniqueAppName(e.body.name,function(t,n){t?(logger.error("Get app name error."),i.send({success:!1,message:"Failed to duplicate app."})):insertAndCopyApp({name:n,description:e.body.description,lastUpdated:getCurrentTime(),is3D:e.body.is3D,creator:e.body.creator,modified:e.body.creator},e.body.id,function(t,o){t?(logger.error("Duplicate app failed, app name:",e.body.name),i.send({success:!1})):(logger.info("Duplicate app",e.body.name,"to",n),i.send({success:!0,newAppId:o[0].id,newName:n}))})})},exports.downloadAGOLTemplate=function(e,i){var t=e.params.appId,n=getZipFilePath(t),o=getAGOLZipFilePath(t);findApps({_id:t},function(e,s){if(e)return void console.error("find app failed when download AGOL template: "+e);var r=s[0],p=JSON.parse(r.agolTemplateJson);p.configurationSettings.forEach(function(e){delete e.categoryName,e.fields.forEach(function(e){delete e.id})}),fs.existsSync(o)?i.download(o):fs.existsSync(n)?(zipAGOLApp(n,JSON.stringify(p),t),i.download(o,r.name+"_AGOLTemplate.zip")):zipApp(t,function(e){e?i.send({success:!1}):zipAGOLApp(n,JSON.stringify(p),t)?i.download(o,r.name+"_AGOLTemplate.zip"):i.send({success:!1})})})};